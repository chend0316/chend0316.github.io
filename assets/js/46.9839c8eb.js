(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{415:function(s,a,t){"use strict";t.r(a);var n=t(42),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"小实验：编译、链接"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#小实验：编译、链接"}},[s._v("#")]),s._v(" 小实验：编译、链接")]),s._v(" "),t("h2",{attrs:{id:"编译时链接静态库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#编译时链接静态库"}},[s._v("#")]),s._v(" 编译时链接静态库")]),s._v(" "),t("p",[s._v("若main.c想要使用外部库中的一些函数、变量，需要将其链接（Link）进来。")]),s._v(" "),t("h3",{attrs:{id:"理论"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#理论"}},[s._v("#")]),s._v(" 理论")]),s._v(" "),t("h3",{attrs:{id:"库（library）"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#库（library）"}},[s._v("#")]),s._v(" 库（Library）")]),s._v(" "),t("p",[s._v("在"),t("code",[s._v("/usr/lib/")]),s._v("目录下可以找到很多库，文件名形如"),t("code",[s._v("libxxx.so")]),s._v("或"),t("code",[s._v("libxxx.a")]),s._v("，那么这个库的名字就叫xxx。")]),s._v(" "),t("h4",{attrs:{id:"符号（symbol）表"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#符号（symbol）表"}},[s._v("#")]),s._v(" 符号（Symbol）表")]),s._v(" "),t("p",[s._v("库和可执行文件都会有符号，在Linux下可以通过"),t("code",[s._v("nm")]),s._v("命令来查看一个文件的符号表。")]),s._v(" "),t("h4",{attrs:{id:"c语言编译、链接过程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#c语言编译、链接过程"}},[s._v("#")]),s._v(" C语言编译、链接过程")]),s._v(" "),t("p",[s._v("C代码首先会"),t("code",[s._v("编译")]),s._v("成为机器指令，函数和变量经过编译成为了符号，此时的符号都还没有分配具体的地址，因此是不可执行的。随后需要进行"),t("code",[s._v("链接")]),s._v("，链接会为符号分配地址，链接后得到的就是可执行文件了。\n可以通过编译选项"),t("code",[s._v("gcc -l")]),s._v("链接外部库。")]),s._v(" "),t("h3",{attrs:{id:"实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实践"}},[s._v("#")]),s._v(" 实践")]),s._v(" "),t("p",[s._v("这个实验主要是体会编译、链接这两个步骤。")]),s._v(" "),t("h4",{attrs:{id:"实验指导"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实验指导"}},[s._v("#")]),s._v(" 实验指导")]),s._v(" "),t("p",[s._v("对于这样的一个程序：")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<stdio.h>")])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("msg "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello world!"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%s\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" msg"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("实验步骤：")]),s._v(" "),t("ul",[t("li",[s._v("编译但不链接："),t("code",[s._v("gcc -c hello.c -o hello.o")]),s._v("，它会编译"),t("code",[s._v("hello.c")]),s._v("并生成"),t("code",[s._v("hello.o")]),s._v("文件。"),t("code",[s._v("-c")]),s._v("选项告诉"),t("code",[s._v("gcc")]),s._v("只编译不链接。")]),s._v(" "),t("li",[s._v("链接："),t("code",[s._v("gcc hello.o -lc -o hello")]),s._v("，得到可执行文件"),t("code",[s._v("hello")]),s._v("。其中"),t("code",[s._v("-lc")]),s._v("是链接C标准库，"),t("code",[s._v("-lc")]),s._v("的意思是链一个叫做c的库，"),t("code",[s._v("-labc")]),s._v("的意思是链接一个叫做abc的库。")])]),s._v(" "),t("p",[s._v("查看符号表，体会链接前后的差异（链接后符号分配了地址）：")]),s._v(" "),t("ul",[t("li",[s._v("执行"),t("code",[s._v("nm ./hello.o")])]),s._v(" "),t("li",[s._v("执行"),t("code",[s._v("nm ./hello")])])]),s._v(" "),t("h4",{attrs:{id:"实验结果"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实验结果"}},[s._v("#")]),s._v(" 实验结果")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("hello.o")]),s._v("的符号表：")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("0000000000000000 T _main\n0000000000000048 D _msg\n                 U _printf  # 这个U的意思是undefined，未定义\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("ul",[t("li",[t("code",[s._v("hello")]),s._v("的符号表：")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("0000000100000f50 T _main\n0000000100000fa2 S _msg\n                 U _printf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h2",{attrs:{id:"如何创建库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#如何创建库"}},[s._v("#")]),s._v(" 如何创建库")]),s._v(" "),t("p",[s._v("链接分为动态链接和静态链接。静态库的文件名为"),t("code",[s._v("libxxx.a")]),s._v("，动态库的文件名为"),t("code",[s._v("libxxx.so")]),s._v("。")]),s._v(" "),t("h3",{attrs:{id:"理论-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#理论-2"}},[s._v("#")]),s._v(" 理论")]),s._v(" "),t("h4",{attrs:{id:"静态库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#静态库"}},[s._v("#")]),s._v(" 静态库")]),s._v(" "),t("p",[s._v("创建名为math的静态库，分编译、打包两个步骤：")]),s._v(" "),t("ul",[t("li",[s._v("第一步，编译，但不链接："),t("code",[s._v("gcc -c infile.c -o outfile.o")])]),s._v(" "),t("li",[s._v("第二步，打包："),t("code",[s._v("ar -rcs libmath.a outfile1.o outfile2.o")])])]),s._v(" "),t("h4",{attrs:{id:"动态库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#动态库"}},[s._v("#")]),s._v(" 动态库")]),s._v(" "),t("p",[s._v("创建名为math的动态库：")]),s._v(" "),t("ul",[t("li",[s._v("第一步："),t("code",[s._v("gcc -c -fPIC infile.c -o outfile.o")])]),s._v(" "),t("li",[s._v("其中"),t("code",[s._v("-fPIC")]),s._v("意思是生成位置无关码（Position Independent Code）")]),s._v(" "),t("li",[s._v("第二步："),t("code",[s._v("ld -shared -soname libmath.so -o libmath.so outfile1.o outfile2.o")])]),s._v(" "),t("li",[s._v("可能还要配置"),t("code",[s._v("LD_LIBRARY_PATH")]),s._v("环境变量")]),s._v(" "),t("li",[s._v("可能还要执行"),t("code",[s._v("ldconfig")]),s._v("命令")])]),s._v(" "),t("h3",{attrs:{id:"实践-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实践-2"}},[s._v("#")]),s._v(" 实践")]),s._v(" "),t("p",[s._v("为了加深理解，尝试以下实验。")]),s._v(" "),t("h4",{attrs:{id:"实验指导-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实验指导-2"}},[s._v("#")]),s._v(" 实验指导")]),s._v(" "),t("p",[s._v("main.c代码如下：")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// main.c")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<stdio.h>")])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" a"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%d\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("math.c代码如下：")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" a"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" a "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("创建动态库的步骤：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("gcc -c -fPIC math.c -o math.o")])]),s._v(" "),t("li",[t("code",[s._v("ld -shared -soname libmath.so -o libmath.so math.o")])]),s._v(" "),t("li",[t("code",[s._v("gcc main.c -L./ -lmath -o main_shared")])]),s._v(" "),t("li",[s._v("运行："),t("code",[s._v("LD_LIBRARY_PATH=$(pwd) ./main_shared")])])]),s._v(" "),t("p",[s._v("创建静态库的步骤：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("gcc -c math.c -o math.o")])]),s._v(" "),t("li",[t("code",[s._v("ar -rcs libmath.a math.o")])]),s._v(" "),t("li",[t("code",[s._v("gcc main.c -L./ -lmath -o main_static")])]),s._v(" "),t("li",[s._v("运行："),t("code",[s._v("./main_static")])])]),s._v(" "),t("p",[s._v("下面体会动态库和静态库的区别：")]),s._v(" "),t("ul",[t("li",[s._v("分别敲"),t("code",[s._v("ldd main_shared")]),s._v("和"),t("code",[s._v("ldd main_static")]),s._v("，体会二者区别")]),s._v(" "),t("li",[s._v("分别敲"),t("code",[s._v("ls -al ./main_shared")]),s._v("和"),t("code",[s._v("ls -al ./main_static")]),s._v("，体会两个文件的大小区别")]),s._v(" "),t("li",[s._v("分别敲"),t("code",[s._v("nm ./main_shared")]),s._v("和"),t("code",[s._v("nm ./main_static")]),s._v("，体会二者符号表的区别，重点关注"),t("code",[s._v("add")]),s._v("符号")]),s._v(" "),t("li",[s._v("删除"),t("code",[s._v("libmath.a")]),s._v("后"),t("code",[s._v("main_static")]),s._v("还能运行，但删除"),t("code",[s._v("libmath.so")]),s._v("后"),t("code",[s._v("main_shared")]),s._v("不能运行了")]),s._v(" "),t("li",[s._v("将"),t("code",[s._v("libmath.so")]),s._v("移动到其它目录后，必须相应更新"),t("code",[s._v("LD_LIBRARY_PATH")]),s._v("才能运行"),t("code",[s._v("main_shared")])])]),s._v(" "),t("p",[s._v("实验注意事项：")]),s._v(" "),t("ul",[t("li",[s._v("如果同时有"),t("code",[s._v("libmath.so")]),s._v("和"),t("code",[s._v("libmath.a")]),s._v("，那么会优先使用"),t("code",[s._v(".so")]),s._v("，所以在做静态库实验时，确保已经删除了"),t("code",[s._v("libmath.so")])])]),s._v(" "),t("h4",{attrs:{id:"实验结果-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实验结果-2"}},[s._v("#")]),s._v(" 实验结果")]),s._v(" "),t("p",[t("code",[s._v("main_shared")]),s._v("的符号表大概是这样的，其中"),t("code",[s._v("add")]),s._v("符号是未定义：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("00000000000005a8 T _init\n0000000000000600 T _start\n                 U add\n0000000000201010 b completed.7696\n0000000000201000 W data_start\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[t("code",[s._v("main_static")]),s._v("大概是这样的，其中"),t("code",[s._v("add")]),s._v("符号有定义：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("00000000000004f0 T _init\n0000000000000540 T _start\n0000000000000677 T add\n0000000000201010 b completed.7696\n0000000000201000 W data_start\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[t("code",[s._v("ldd main_shared")]),s._v("比"),t("code",[s._v("ldd main_static")]),s._v("多了一个东西：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# main_shared的结果\n        linux-vdso.so.1 (0x00007fff06f13000)\n        libmath.so => not found\n        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f7178212000)\n        /lib64/ld-linux-x86-64.so.2 (0x00007f7178805000)\n\n# main_static的结果\n        linux-vdso.so.1 (0x00007ffd0bd93000)\n        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f8b7c07e000)\n        /lib64/ld-linux-x86-64.so.2 (0x00007f8b7c671000)\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("h2",{attrs:{id:"运行时加载动态库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#运行时加载动态库"}},[s._v("#")]),s._v(" 运行时加载动态库")]),s._v(" "),t("p",[s._v("通过"),t("code",[s._v("dlopen()")]),s._v("在运行时加载动态库，也能做到调用动态库中提供的函数、变量，这比编译时链接要更加灵活。")]),s._v(" "),t("h3",{attrs:{id:"理论-3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#理论-3"}},[s._v("#")]),s._v(" 理论")]),s._v(" "),t("p",[t("code",[s._v("dlfcn.h")]),s._v("中定义了一些函数，这些函数不是C标准库的一部分，因此想要用的话必须加上"),t("code",[s._v("-ldl")]),s._v("编译选项：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("void *dlopen(const char *file, int mode);")]),s._v("，返回一个handle")]),s._v(" "),t("li",[t("code",[s._v("void *dlsym(void *handle, const char *symbol_name);")]),s._v("，用于查询符号（即变量或函数）的地址")]),s._v(" "),t("li",[t("code",[s._v("int dlclose(void *handle);")]),s._v("，库调用完后通过此函数关闭库\n"),t("code",[s._v("mode")]),s._v("参数分为：")]),s._v(" "),t("li",[s._v("RTLD_LAZY")]),s._v(" "),t("li",[s._v("RTLD_NOW")]),s._v(" "),t("li",[s._v("RTLD_GLOBAL")]),s._v(" "),t("li",[s._v("RTLD_LOCAL")])]),s._v(" "),t("h3",{attrs:{id:"实践-3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实践-3"}},[s._v("#")]),s._v(" 实践")]),s._v(" "),t("p",[s._v("之前我们已经创建了"),t("code",[s._v("libmath.so")]),s._v("这个动态库，下面写一个"),t("code",[s._v("main.c")]),s._v("来调用math库中的add函数。")]),s._v(" "),t("h4",{attrs:{id:"实验指导-3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实验指导-3"}},[s._v("#")]),s._v(" 实验指导")]),s._v(" "),t("p",[s._v("代码如下：")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<stdio.h>")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<dlfcn.h>")])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("add"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" a"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("handle "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dlopen")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./libmath.so"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" RTLD_NOW"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    add "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dlsym")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("handle"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"add"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("add "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"error\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%d\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("p",[s._v("实验步骤：")]),s._v(" "),t("ul",[t("li",[s._v("编译："),t("code",[s._v("gcc main.c -ldl -o main")])]),s._v(" "),t("li",[s._v("运行："),t("code",[s._v("./main")])])])])}),[],!1,null,null,null);a.default=e.exports}}]);
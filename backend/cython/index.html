<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Cython入门教程 | 陈东的博客</title>
    <meta name="generator" content="VuePress 1.5.3">
    
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.abfd12c2.css" as="style"><link rel="preload" href="/assets/js/app.ff6f6b81.js" as="script"><link rel="preload" href="/assets/js/2.69342379.js" as="script"><link rel="preload" href="/assets/js/4.f6800b1c.js" as="script"><link rel="prefetch" href="/assets/js/10.c3ad9a92.js"><link rel="prefetch" href="/assets/js/100.2ce983e4.js"><link rel="prefetch" href="/assets/js/101.e9d18993.js"><link rel="prefetch" href="/assets/js/102.0e18f7f3.js"><link rel="prefetch" href="/assets/js/103.92eefaa2.js"><link rel="prefetch" href="/assets/js/104.7960e86e.js"><link rel="prefetch" href="/assets/js/105.225d0d1f.js"><link rel="prefetch" href="/assets/js/106.e2972bce.js"><link rel="prefetch" href="/assets/js/107.95d603bc.js"><link rel="prefetch" href="/assets/js/108.a0b4a47f.js"><link rel="prefetch" href="/assets/js/109.5f5bef11.js"><link rel="prefetch" href="/assets/js/11.f2283be1.js"><link rel="prefetch" href="/assets/js/110.b9972ee4.js"><link rel="prefetch" href="/assets/js/111.01c6155b.js"><link rel="prefetch" href="/assets/js/112.4d80636b.js"><link rel="prefetch" href="/assets/js/113.3a0a478b.js"><link rel="prefetch" href="/assets/js/114.ddb91394.js"><link rel="prefetch" href="/assets/js/115.bc478be0.js"><link rel="prefetch" href="/assets/js/116.3f6c33aa.js"><link rel="prefetch" href="/assets/js/117.3cd3c216.js"><link rel="prefetch" href="/assets/js/12.9682ba28.js"><link rel="prefetch" href="/assets/js/13.80e3a96c.js"><link rel="prefetch" href="/assets/js/14.e153cf79.js"><link rel="prefetch" href="/assets/js/15.e60e902c.js"><link rel="prefetch" href="/assets/js/16.9486e801.js"><link rel="prefetch" href="/assets/js/17.b6bc78d4.js"><link rel="prefetch" href="/assets/js/18.083c01ee.js"><link rel="prefetch" href="/assets/js/19.70912055.js"><link rel="prefetch" href="/assets/js/20.3c545495.js"><link rel="prefetch" href="/assets/js/21.73e3d881.js"><link rel="prefetch" href="/assets/js/22.e607b97a.js"><link rel="prefetch" href="/assets/js/23.978c7d99.js"><link rel="prefetch" href="/assets/js/24.1b4d915e.js"><link rel="prefetch" href="/assets/js/25.851a206c.js"><link rel="prefetch" href="/assets/js/26.f9fcea22.js"><link rel="prefetch" href="/assets/js/27.fde78465.js"><link rel="prefetch" href="/assets/js/28.4b7b6164.js"><link rel="prefetch" href="/assets/js/29.00296663.js"><link rel="prefetch" href="/assets/js/3.e11b8926.js"><link rel="prefetch" href="/assets/js/30.f6efbdd5.js"><link rel="prefetch" href="/assets/js/31.70a67be5.js"><link rel="prefetch" href="/assets/js/32.1d970c11.js"><link rel="prefetch" href="/assets/js/33.5af0776d.js"><link rel="prefetch" href="/assets/js/34.c69357a7.js"><link rel="prefetch" href="/assets/js/35.f18bf065.js"><link rel="prefetch" href="/assets/js/36.07d69c89.js"><link rel="prefetch" href="/assets/js/37.a42818af.js"><link rel="prefetch" href="/assets/js/38.9ba9b088.js"><link rel="prefetch" href="/assets/js/39.80cd8820.js"><link rel="prefetch" href="/assets/js/40.6a6e1a23.js"><link rel="prefetch" href="/assets/js/41.b3ae5317.js"><link rel="prefetch" href="/assets/js/42.1aae4a1b.js"><link rel="prefetch" href="/assets/js/43.e0051c0c.js"><link rel="prefetch" href="/assets/js/44.0d5e196a.js"><link rel="prefetch" href="/assets/js/45.c85c7030.js"><link rel="prefetch" href="/assets/js/46.7e3394f2.js"><link rel="prefetch" href="/assets/js/47.a7e54f11.js"><link rel="prefetch" href="/assets/js/48.deee15ff.js"><link rel="prefetch" href="/assets/js/49.13f2954e.js"><link rel="prefetch" href="/assets/js/5.180c9d7d.js"><link rel="prefetch" href="/assets/js/50.308697a4.js"><link rel="prefetch" href="/assets/js/51.a58f09b5.js"><link rel="prefetch" href="/assets/js/52.30e62359.js"><link rel="prefetch" href="/assets/js/53.bb3abbb1.js"><link rel="prefetch" href="/assets/js/54.d64c6dad.js"><link rel="prefetch" href="/assets/js/55.24a74513.js"><link rel="prefetch" href="/assets/js/56.a6b3c398.js"><link rel="prefetch" href="/assets/js/57.0ab4d15c.js"><link rel="prefetch" href="/assets/js/58.411dfc00.js"><link rel="prefetch" href="/assets/js/59.e49534d5.js"><link rel="prefetch" href="/assets/js/6.b0fcf329.js"><link rel="prefetch" href="/assets/js/60.2cd9032f.js"><link rel="prefetch" href="/assets/js/61.50bfded6.js"><link rel="prefetch" href="/assets/js/62.4609088f.js"><link rel="prefetch" href="/assets/js/63.a84b754e.js"><link rel="prefetch" href="/assets/js/64.b48fdab8.js"><link rel="prefetch" href="/assets/js/65.f76db9fa.js"><link rel="prefetch" href="/assets/js/66.b1015305.js"><link rel="prefetch" href="/assets/js/67.b9fed10a.js"><link rel="prefetch" href="/assets/js/68.e259fcce.js"><link rel="prefetch" href="/assets/js/69.86862e4c.js"><link rel="prefetch" href="/assets/js/7.a318c558.js"><link rel="prefetch" href="/assets/js/70.634b8ffc.js"><link rel="prefetch" href="/assets/js/71.6df4e74f.js"><link rel="prefetch" href="/assets/js/72.71f1c3e6.js"><link rel="prefetch" href="/assets/js/73.45b8a31a.js"><link rel="prefetch" href="/assets/js/74.d7026358.js"><link rel="prefetch" href="/assets/js/75.223cae2f.js"><link rel="prefetch" href="/assets/js/76.ab935578.js"><link rel="prefetch" href="/assets/js/77.e6a710a8.js"><link rel="prefetch" href="/assets/js/78.c52c90b7.js"><link rel="prefetch" href="/assets/js/79.6216e524.js"><link rel="prefetch" href="/assets/js/8.c975681b.js"><link rel="prefetch" href="/assets/js/80.ca203dcc.js"><link rel="prefetch" href="/assets/js/81.690f2e6c.js"><link rel="prefetch" href="/assets/js/82.357cb3ad.js"><link rel="prefetch" href="/assets/js/83.9cb937f0.js"><link rel="prefetch" href="/assets/js/84.c3ca8537.js"><link rel="prefetch" href="/assets/js/85.f2744611.js"><link rel="prefetch" href="/assets/js/86.080100fc.js"><link rel="prefetch" href="/assets/js/87.cd488b65.js"><link rel="prefetch" href="/assets/js/88.6414ab0a.js"><link rel="prefetch" href="/assets/js/89.acf0fd59.js"><link rel="prefetch" href="/assets/js/9.ff3c8afd.js"><link rel="prefetch" href="/assets/js/90.0fc204d9.js"><link rel="prefetch" href="/assets/js/91.116e3a2e.js"><link rel="prefetch" href="/assets/js/92.8e4fe29e.js"><link rel="prefetch" href="/assets/js/93.6f276a4d.js"><link rel="prefetch" href="/assets/js/94.bf621b6e.js"><link rel="prefetch" href="/assets/js/95.ea3d782c.js"><link rel="prefetch" href="/assets/js/96.fef23b36.js"><link rel="prefetch" href="/assets/js/97.a11ec290.js"><link rel="prefetch" href="/assets/js/98.2cd95a98.js"><link rel="prefetch" href="/assets/js/99.c5cefc73.js">
    <link rel="stylesheet" href="/assets/css/0.styles.abfd12c2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">陈东的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="程序员基本功" class="dropdown-title"><span class="title">程序员基本功</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/programmer/leetcode/" class="nav-link">
  力扣刷题
</a></li><li class="dropdown-item"><!----> <a href="/programmer/design-pattern/" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/programmer/web-architecture.html" class="nav-link">
  Web架构师
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/admin-in-action/" class="nav-link">
  开发实战
</a></li><li class="dropdown-item"><h4>
          基本功
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend/javascript/" class="nav-link">
  JavaScript 语言
</a></li><li class="dropdown-subitem"><a href="/frontend/api/" class="nav-link">
  JavaScript API
</a></li><li class="dropdown-subitem"><a href="/frontend/browser/" class="nav-link">
  浏览器
</a></li></ul></li><li class="dropdown-item"><h4>
          框架 &amp; 工具
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend/framework/" class="nav-link">
  三大框架
</a></li><li class="dropdown-subitem"><a href="/frontend/webpack/" class="nav-link">
  Webpack
</a></li></ul></li><li class="dropdown-item"><h4>
          跨平台
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend/mini-program/" class="nav-link">
  微信小程序
</a></li><li class="dropdown-subitem"><a href="/frontend/flutter/" class="nav-link">
  Flutter
</a></li><li class="dropdown-subitem"><a href="/frontend/electron/" class="nav-link">
  Electron
</a></li></ul></li><li class="dropdown-item"><h4>
          其它
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend/performance/" class="nav-link">
  性能
</a></li><li class="dropdown-subitem"><a href="/frontend/visualization/" class="nav-link">
  可视化
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/backend/spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/backend/database/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/backend/docker.html" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><h4>
          其它
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/cython/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Cython
</a></li><li class="dropdown-subitem"><a href="/backend/protobuf/" class="nav-link">
  Protobuf
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机专业" class="dropdown-title"><span class="title">计算机专业</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cs/network/" class="nav-link">
  计算机网络
</a></li></ul></div></div> <a href="https://github.com/chend0316/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="程序员基本功" class="dropdown-title"><span class="title">程序员基本功</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/programmer/leetcode/" class="nav-link">
  力扣刷题
</a></li><li class="dropdown-item"><!----> <a href="/programmer/design-pattern/" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/programmer/web-architecture.html" class="nav-link">
  Web架构师
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/admin-in-action/" class="nav-link">
  开发实战
</a></li><li class="dropdown-item"><h4>
          基本功
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend/javascript/" class="nav-link">
  JavaScript 语言
</a></li><li class="dropdown-subitem"><a href="/frontend/api/" class="nav-link">
  JavaScript API
</a></li><li class="dropdown-subitem"><a href="/frontend/browser/" class="nav-link">
  浏览器
</a></li></ul></li><li class="dropdown-item"><h4>
          框架 &amp; 工具
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend/framework/" class="nav-link">
  三大框架
</a></li><li class="dropdown-subitem"><a href="/frontend/webpack/" class="nav-link">
  Webpack
</a></li></ul></li><li class="dropdown-item"><h4>
          跨平台
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend/mini-program/" class="nav-link">
  微信小程序
</a></li><li class="dropdown-subitem"><a href="/frontend/flutter/" class="nav-link">
  Flutter
</a></li><li class="dropdown-subitem"><a href="/frontend/electron/" class="nav-link">
  Electron
</a></li></ul></li><li class="dropdown-item"><h4>
          其它
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend/performance/" class="nav-link">
  性能
</a></li><li class="dropdown-subitem"><a href="/frontend/visualization/" class="nav-link">
  可视化
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/backend/spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/backend/database/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/backend/docker.html" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><h4>
          其它
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/cython/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Cython
</a></li><li class="dropdown-subitem"><a href="/backend/protobuf/" class="nav-link">
  Protobuf
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机专业" class="dropdown-title"><span class="title">计算机专业</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cs/network/" class="nav-link">
  计算机网络
</a></li></ul></div></div> <a href="https://github.com/chend0316/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Cython入门教程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/backend/cython/#第1章-cython的安装和使用" class="sidebar-link">第1章 Cython的安装和使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/cython/#_1-1-安装" class="sidebar-link">1.1 安装</a></li><li class="sidebar-sub-header"><a href="/backend/cython/#_1-2-快速入门" class="sidebar-link">1.2 快速入门</a></li><li class="sidebar-sub-header"><a href="/backend/cython/#_1-3-cython实现python调用c库" class="sidebar-link">1.3 Cython实现Python调用C库</a></li><li class="sidebar-sub-header"><a href="/backend/cython/#_1-4-手工gcc编译" class="sidebar-link">1.4 手工gcc编译</a></li></ul></li><li><a href="/backend/cython/#第2章-cython封装c库基础" class="sidebar-link">第2章 Cython封装C库基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/cython/#_2-1-在cython中调用c库函数" class="sidebar-link">2.1 在Cython中调用C库函数</a></li><li class="sidebar-sub-header"><a href="/backend/cython/#_2-2-实现python环境调用c库函数" class="sidebar-link">2.2 实现Python环境调用C库函数</a></li><li class="sidebar-sub-header"><a href="/backend/cython/#_2-3-回调函数" class="sidebar-link">2.3 回调函数</a></li><li class="sidebar-sub-header"><a href="/backend/cython/#_2-4-异步回调" class="sidebar-link">2.4 异步回调</a></li><li class="sidebar-sub-header"><a href="/backend/cython/#_2-5-结构体的封装" class="sidebar-link">2.5 结构体的封装</a></li></ul></li><li><a href="/backend/cython/#第3章-pxd文件" class="sidebar-link">第3章 pxd文件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/cython/#_3-1-名称冲突问题" class="sidebar-link">3.1 名称冲突问题</a></li><li class="sidebar-sub-header"><a href="/backend/cython/#_3-2-cython代码复用" class="sidebar-link">3.2 Cython代码复用</a></li></ul></li><li><a href="/backend/cython/#第4章-异步和内存管理" class="sidebar-link">第4章 异步和内存管理</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/backend/cython/#附录：cython语法参考" class="sidebar-link">附录：Cython语法参考</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="cython入门教程"><a href="#cython入门教程" class="header-anchor">#</a> Cython入门教程</h1> <p>好好的为何要混合Python代码和C代码呢？原因主要有2个：</p> <ul><li>Python性能差，将一部分核心逻辑用C语言实现以提升整体性能</li> <li>希望Python能够调用一个C语言实现的系统，典型例子：OpenCV计算机视觉库</li></ul> <p>Python、C混合编程并不奇怪，Python官方就提供了Python/C API可以实现「用C语言编写Python库」，见<a href="https://docs.python.org/3/c-api/index.html" target="_blank" rel="noopener noreferrer">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，如果你点开看了你可能就会发现，这好难啊！Python/C API入门门槛太高，于是有了Cython的诞生。</p> <p>Cython是基于Python/C API的，但学习Cython的时候完全不用了解Python/C API。
<img src="/assets/img/0.c596b8fd.png" alt=""></p> <h2 id="第1章-cython的安装和使用"><a href="#第1章-cython的安装和使用" class="header-anchor">#</a> 第1章 Cython的安装和使用</h2> <h3 id="_1-1-安装"><a href="#_1-1-安装" class="header-anchor">#</a> 1.1 安装</h3> <p>在Linux下通过<code>pip install Cython</code>安装。安装完毕后执行<code>cython --version</code>，如果输出了版本号即安装成功。</p> <h3 id="_1-2-快速入门"><a href="#_1-2-快速入门" class="header-anchor">#</a> 1.2 快速入门</h3> <blockquote><p>本节完整代码见<a href="https://github.com/chend0316/cython_tutorial/tree/master/ch1/1_helloworld" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>安装完成后，我们创建一个Hello World项目，需要创建<code>hello.pyx</code>和<code>setup.py</code>两个文件。</p> <div class="language- extra-class"><pre class="language-text"><code># file: hello.pyx
def say_hello_to(name):
    print(&quot;Hello %s!&quot; % name)
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># file: setup.py</span>
<span class="token keyword">from</span> distutils<span class="token punctuation">.</span>core <span class="token keyword">import</span> setup
<span class="token keyword">from</span> Cython<span class="token punctuation">.</span>Build <span class="token keyword">import</span> cythonize

setup<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'Hello world app'</span><span class="token punctuation">,</span>
      ext_modules<span class="token operator">=</span>cythonize<span class="token punctuation">(</span><span class="token string">&quot;hello.pyx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>这样编译项目：<code>python setup.py build_ext --inplace</code>，会生成<code>hello.so</code>以及一些没用的中间文件。
下面测试我们生成的<code>hello.so</code>能不能用：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># coding: utf-8</span>
<span class="token comment"># 这个import会先找hello.py，找不到就会找hello.so</span>
<span class="token keyword">import</span> hello  <span class="token comment"># 导入了hello.so</span>

hello<span class="token punctuation">.</span>say_hello_to<span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_1-3-cython实现python调用c库"><a href="#_1-3-cython实现python调用c库" class="header-anchor">#</a> 1.3 Cython实现Python调用C库</h3> <blockquote><p>完整代码见<a href="https://github.com/chend0316/cython_tutorial/tree/master/ch1/2_math" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>如果我们已经有一个C语言的动态库、静态库，如何在Python中调用外部C库呢（本节以动态库为例）？</p> <p>现有C库如下，是一个叫做cmath的库：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// file: cmath.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;cmath.h&quot;</span></span>
<span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// file: cmath.h</span>
<span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>下面将该cmath封装为Python库，为了防止名称冲突，命名为pymath：</p> <div class="language- extra-class"><pre class="language-text"><code># file: pymath.pyx
cdef extern from &quot;cmath.h&quot;:
    int add(int a, int b)

def pyadd(int a, int b):
    return add(a, b)
</code></pre></div><p>然后还需要写<code>setup.py</code>，但这里不想写<code>setup.py</code>了，因为本文主要使用gcc手工编译的方式。</p> <h3 id="_1-4-手工gcc编译"><a href="#_1-4-手工gcc编译" class="header-anchor">#</a> 1.4 手工gcc编译</h3> <blockquote><p>本节完整代码见<a href="https://github.com/chend0316/cython_tutorial/tree/master/ch1/3_gcc" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>本节介绍gcc这种比较原始的编译方式，是希望你能搞懂Cython如何运作。如果能掌握那么相信在日后的开发工作中各种编译、部署的问题都不太可能难倒你。</p> <p>我们知道Ubuntu下Python是这样安装的：<code>apt-get install python3</code>，但你可能不知道有这个东西：<code>apt-get install python3-dev</code>。
<code>python3-dev</code>这个包安装的是Python的头文件，以Ubuntu 18.04为例，安装完成后你应该可以在<code>/usr/include/python3.6/</code>找到一些头文件。</p> <p>看图1-1可以看到3种方式的对比：</p> <ul><li>第一条线是用Python/C API，有2个哭脸，不但代码写起来烦人，编译构建也烦人，所以我们才用Cython取代Python/C API；</li> <li>第二条线是我们最常用的setup.py，有2个笑脸，Cython项目最常用的方式；</li> <li>第三条线有1个哭脸，也是本节要讲的，如何使用gcc这种传统的方式来编译Cython项目；</li></ul> <p><img src="/assets/img/1-1.4471c396.png" alt=""></p> <p>主要步骤是：</p> <ul><li>使用<code>cython xxx.pyx</code>生成<code>xxx.c</code></li> <li>然后使用<code>gcc -fPIC -shared -I/usr/include/python2.7/ xxx.c -o xxx.so</code>来生成so文件</li> <li>要注意头文件版本，自己用的是python2的头文件还是python3的头文件</li></ul> <h2 id="第2章-cython封装c库基础"><a href="#第2章-cython封装c库基础" class="header-anchor">#</a> 第2章 Cython封装C库基础</h2> <h3 id="_2-1-在cython中调用c库函数"><a href="#_2-1-在cython中调用c库函数" class="header-anchor">#</a> 2.1 在Cython中调用C库函数</h3> <blockquote><p>本节完整代码见<a href="https://github.com/chend0316/cython_tutorial/tree/master/ch2/1_function" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>C语言有很多库函数，例如：</p> <ul><li>libc的<code>atoi</code>函数</li> <li>math库的<code>sin</code>函数</li></ul> <p>这些库函数非常常用，所以Cython已经帮我们封装了，所以我们直接调用即可。
那么Cython到底帮我们封装了多少C库函数呢？你可以在<a href="https://github.com/cython/cython/tree/master/Cython/Includes" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>找找。
如果你需要调用的函数Cython没有封装，那么你需要自己封装，会在2.2节介绍。</p> <p>现在我们看下Cython如何调用这些封装好的C库函数：</p> <div class="language- extra-class"><pre class="language-text"><code># file: demo.pyx
from libc.math cimport sin
from libc.stdlib cimport atof

def foo(char *s):
    x = atof(s)
    return sin(x)
</code></pre></div><p>测试一下可不可以用：</p> <div class="language- extra-class"><pre class="language-text"><code># file: test.py
import demo
print(demo.foo(&quot;3.1415&quot;))  # 答案约等于0
</code></pre></div><h3 id="_2-2-实现python环境调用c库函数"><a href="#_2-2-实现python环境调用c库函数" class="header-anchor">#</a> 2.2 实现Python环境调用C库函数</h3> <blockquote><p>本节完整代码见<a href="https://github.com/chend0316/cython_tutorial/tree/master/ch2/2_wrap_function" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p></blockquote> <p>在2.1节我们已经看到Cython能够调用C函数，Cython中定义的函数能被Python调用，因此Cython就成为了Python调用C的“桥梁”，我们把这一过程叫做wrap，实现这一功能的Cython代码叫做wrapper，见图2-1。通常wrapper可以指一段代码、一个类，甚至也能泛指一类技术。</p> <p><img src="/assets/img/2-1.dbac6799.png" alt=""></p> <p>就和C语言开发一样，Cython代码也需要：包含头文件、链接静态库/动态库。</p> <p>对于这几个C结构体、函数：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// file: queue.h</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_Queue</span> Queue<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token operator">*</span>QueueValue<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">_Queue</span> <span class="token punctuation">{</span>
	QueueEntry <span class="token operator">*</span>head<span class="token punctuation">;</span>
	QueueEntry <span class="token operator">*</span>tail<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
Queue <span class="token operator">*</span><span class="token function">queue_new</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">queue_free</span><span class="token punctuation">(</span>Queue <span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>希望在Cython中调用：</p> <div class="language- extra-class"><pre class="language-text"><code># file: queue.pyx
cdef extern from &quot;queue.h&quot;:  # 包含头文件
    ctypedef struct Queue:
        pass
    ctypedef void *QueueValue

    Queue *queue_new()
    void queue_free(Queue *queue)

def foo():
    # 虽然没有实际意义，但这段代码很自嗨，可以看到Cython中完全可以调用C函数
    cdef Queue *q
    q = queue_new()
    queue_free(q)
</code></pre></div><p>上面代码看出来虽然Cython可以调用C，但作为wrapper还有一个要求是将C语言自然地封装成Python风格，所以还需要下面这段代码让API更加符合面向对象：</p> <div class="language- extra-class"><pre class="language-text"><code>cdef class PyQueue:
    cdef Queue *_c_queue

    def __cinit__(self):
        self._c_queue = queue_new()

    def __dealloc__(self):
        if self._c_queue is not NULL:
            queue_free(self._c_queue)
</code></pre></div><p>编译：</p> <div class="language- extra-class"><pre class="language-text"><code># file: setup.py
from distutils.core import setup, Extension
from Cython.Build import cythonize

extension = Extension(
    &quot;queue&quot;,
    [&quot;queue.pyx&quot;],
    libraries=[&quot;cqueue&quot;]  # 在这边声明需要链接的C库（libcqueue.so）
)

setup(
    ext_modules=cythonize([extension])
)
</code></pre></div><p>这里只贴了创建、释放的封装。其它功能（如pop、push）见完整代码。</p> <h3 id="_2-3-回调函数"><a href="#_2-3-回调函数" class="header-anchor">#</a> 2.3 回调函数</h3> <blockquote><p>本节完整代码见<a href="https://github.com/chend0316/cython_tutorial/tree/master/ch2/3_callback" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p></blockquote> <p>对于一些需要传入回调函数的接口，会造成调用、被调用关系的反转。在之前我们讨论的都是在Cython中调用C函数，然而回调函数使得问题变为如何让C调用Cython函数。例如现在希望封装一个这样的C函数：</p> <div class="language- extra-class"><pre class="language-text"><code>void traverse(int *arr, int len, void (*cb)(int)) {
    for (int i = 0; i &lt; len; i++) {
        cb(arr[i]);
    }
}
</code></pre></div><p>为了实现回调的封装：</p> <ul><li>首先需要在Cython中定义一个能被C语言调用的<code>wrap_cb</code>，这是容易的</li> <li>然后需要在Cython的<code>wrap_cb</code>中调用Python的回调函数（我们把它叫做<code>app_cb</code>），这步会比较难实现，因为C环境调用<code>wrap_cb</code>时无法将<code>app_cb</code>的信息传入</li></ul> <p>在图2-2展示的方案中，将<code>app_cb</code>存至全局变量，这样<code>wrap_cb</code>可以从全局变量取到<code>app_cb</code>。</p> <p><img src="/assets/img/2-2.f88deea9.png" alt=""></p> <h3 id="_2-4-异步回调"><a href="#_2-4-异步回调" class="header-anchor">#</a> 2.4 异步回调</h3> <p>2.3节中提到的方案不适用于异步场景，见下文专门章节分析异步场景。</p> <h3 id="_2-5-结构体的封装"><a href="#_2-5-结构体的封装" class="header-anchor">#</a> 2.5 结构体的封装</h3> <blockquote><p>本节完整代码见<a href="https://github.com/chend0316/cython_tutorial/tree/master/ch2/4_struct" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p></blockquote> <h2 id="第3章-pxd文件"><a href="#第3章-pxd文件" class="header-anchor">#</a> 第3章 pxd文件</h2> <p>就像C语言有<code>.c</code>和<code>.h</code>文件，Cython有<code>.pyx</code>和<code>.pxd</code>文件，可以帮助更好的组织、管理代码，<code>pxd</code>也可以实现wrapper的复用。</p> <h3 id="_3-1-名称冲突问题"><a href="#_3-1-名称冲突问题" class="header-anchor">#</a> 3.1 名称冲突问题</h3> <blockquote><p>本节完整代码见<a href="https://github.com/chend0316/cython_tutorial/tree/master/ch3/1_pxd" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>在之前的例子中，我们把C函数的导入、Python wrapper的封装都放在了<code>pyx</code>文件中，这会导致一些符号名冲突。例如：</p> <div class="language- extra-class"><pre class="language-text"><code>cdef extern from &quot;queue.h&quot;:
    # 这是声明C语言中有一个名为Queue的结构体
    ctypedef struct Queue:
        pass

# 这是提供给Python用的类，我们其实也想起名叫做Queue，但C语言结构体也叫这个名字
# 所以我们不得不把提供给Python的类名改为PyQueue
cdef class PyQueue:
    cdef Queue *_c_queue

    def __cinit__(self):
        self._c_queue = ...
</code></pre></div><p>为了解决开发中遇到的这些问题，我们可以把声明放在<code>pxd</code>中，这样就多了一层命名空间，如下：</p> <div class="language- extra-class"><pre class="language-text"><code># cqueue.pxd
cdef extern from &quot;queue.h&quot;:
    ctypedef struct Queue:
        pass
</code></pre></div><p>有了命名空间，在<code>pyx</code>中就不会产生符号名冲突了：</p> <div class="language- extra-class"><pre class="language-text"><code># queue.pyx
cimport cqueue
cdef class Queue:
    cdef cqueue.Queue *_c_queue

    def __cinit__(self):
        self._c_queue = ...
</code></pre></div><h3 id="_3-2-cython代码复用"><a href="#_3-2-cython代码复用" class="header-anchor">#</a> 3.2 Cython代码复用</h3> <h2 id="第4章-异步和内存管理"><a href="#第4章-异步和内存管理" class="header-anchor">#</a> 第4章 异步和内存管理</h2> <p>C程序员手动管理内存，而Python得益于垃圾回收机制，程序员无需感知内存管理。</p> <h2 id="附录：cython语法参考"><a href="#附录：cython语法参考" class="header-anchor">#</a> 附录：Cython语法参考</h2> <p>Cython易用的原因是它的代码跟Python几乎一样，Cython的语法是Python的「超集」，即Python代码一定是Cython代码，而Cython代码不一定是Python代码。比起Python来说，Cython多了一些跟C语言相关的语法。</p> <div class="language- extra-class"><pre class="language-text"><code># Python语法
import math  # 导入math.py或math.so或math目录
from math import add as myadd  # Python：导入math.py中的add符号，为避免名字冲突，重命名为myadd
math.add(1, 2)  # 访问math中的add符号
myadd(1, 2)

# 对应的Cython语法
cimport math  # 导入math.pxd
from math cimport add as myadd  # 导入math.pxd中的add符号，为避免名字冲突，重命名为myadd
math.add(1, 2)  # 访问math中的add符号
myadd(1, 2)
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code># Python语法
def foo(a, b):  # 定义foo函数
    c = 0  # 创建Python的int对象
    c = a + b
    return c

# Cython语法
cdef int foo(int a, int b):  # cdef是定义C语言函数，注意该函数不能被Python调用
    cdef int c = 0  # 这是C语言的int变量
    c = a + b
    return c  # 返回C语言的int

# Cython语法
cpdef int foo(int a, int b):  # cpdef定义的函数可以被Python调用
    cdef int c = 0  # C语言的int变量
    c = a + b

    # 返回的是Python的int对象
    # Cython在这里隐式将C语言int变量转为了Python的int对象
    # 因为变量c是基本类型，Cython帮忙转了，如果c是复杂的是不能直接return的
    return c
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code># Python语法
class Person():
    def __init__(self):  # 这是构造函数
        pass

# Cython语法
class Person():
    def __init__(self):  # 和C语言相关的内存分配（如malloc）不能放在这里实现
        pass

    def __cinit__(self):  # 和C语言相关的内存分配（如malloc）要放在这里实现 
        ... = malloc();

    def __dealloc__(self):  # 和C语言相关的内存释放（如free）要放在这里实现 
        free(...);
</code></pre></div><p>写在最后：完整介绍Cython是一个庞大的工程，本文只是介绍了Cython的皮毛，若有疑问欢迎交流。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/chend0316/blog/edit/master/docs/backend/cython/readme.md" target="_blank" rel="noopener noreferrer">编辑此页面</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">最后编辑:</span> <span class="time">1/17/2021, 3:44:12 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ff6f6b81.js" defer></script><script src="/assets/js/2.69342379.js" defer></script><script src="/assets/js/4.f6800b1c.js" defer></script>
  </body>
</html>
